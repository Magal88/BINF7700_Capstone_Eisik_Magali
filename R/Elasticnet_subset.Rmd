---
title: "Elastic net model for subset"
author: "Magalí Eisik"
output:
  html_document:
    df_print: paged
---



In this document,Elastic Net regression is implemented to build an epigenetic clock. Gender is included as a covariate to account for sex differences in DNA methylation. A small balanced subset of samples is used for initial testing and debugging. The workflow includes preparation of predictors (CpGs and gender), cross-validated model fitting, and extraction of selected CpGs and performance metrics.


```{r, message=FALSE,warning=FALSE}
#Load require packages
library(glmnet)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(Metrics)

```


The dataset with median-imputed missing values is used to ensure a complete set of CpGs and samples for Elastic Net modeling.

```{r}
#Load data set
GSE55763_100_imputed <- read.csv("GSE55763_100_imputed.csv", header = TRUE, stringsAsFactors = FALSE)
head(GSE55763_100_imputed,3)
```



Select a small, balanced subset to test and debug the model quickly (10 males and 10 females)

```{r}
subset_df <- GSE55763_100_imputed %>%
  group_by(gender) %>%
  slice_head(n = 10) %>%
  ungroup()
```


```{r}
# CpG columns= predictor
X_subset <- as.matrix(subset_df[, 4:ncol(subset_df)])

gender_subset <- as.factor(subset_df$gender)  # gender= covariate in the model
X_subset <- cbind(X_subset, model.matrix(~ gender_subset - 1))

# Response variable
y_subset <- subset_df$age     #response variable = age
```

```{r}
set.seed(500)   # for reproducible analysis

# Performs cross-validation to find the best lambda:
# alpha-0.5 for penaalty that includes of Ridge + Lasso
# nfolds=5 for 5 fold cross validation (data set is split in 5 equal folds)


cv_enet_subset <- cv.glmnet(X_subset, y_subset, alpha = 0.5, nfolds = 5)

best_lambda_subset <- cv_enet_subset$lambda.min

enet_model_subset <- glmnet(X_subset, y_subset, alpha = 0.5, lambda = best_lambda_subset)
```


Extract cpg weights

```{r}
# Extract coefficients from Elastic Net model
coef_list <- coef(enet_model_subset)

# Convert to data frame and remove intercept
coef_df <- data.frame(
  CpG = rownames(coef_list),
  Weight = coef_list[,1]
)
coef_df <- coef_df[-1,]  # remove intercept

# Order by absolute weight and select top 5
top5_cpgs <- head(coef_df[order(-abs(coef_df$Weight)), ], 5)


top5_cpgs_clean <- data.frame(
  CpG = top5_cpgs$CpG,
  Weight = top5_cpgs$Weight
)

# Display  table
top5_cpgs_clean %>%
  kable("html", caption = "Top 5 CpGs contributing to Elastic Net model") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE)

```




The Elastic Net regression model is evaluated using three key metrics. 
R² (Coefficient of Determination) indicates the proportion of variance in age explained by the model. 
MAE (Mean Absolute Error) measures the average absolute difference between predicted and actual ages. 
RMSE (Root Mean Squared Error) calculates the square root of the average squared differences, giving more weight to larger errors.


```{r}
pred_subset <- predict(enet_model_subset, X_subset)

R2 <- cor(pred_subset, y_subset)^2
MAE <- mean(abs(pred_subset - y_subset))
RMSE <- sqrt(mean((pred_subset - y_subset)^2))

cat(sprintf("Metrics in Subset - Elastic Net: R2=%.3f, MAE=%.3f, RMSE=%.3f\n", R2, MAE, RMSE))
```

```{r}
pred_df <- data.frame(
  ActualAge = y_subset,
  PredictedAge = as.numeric(pred_subset)
)

```



```{r,warning=FALSE}
ggplot(pred_df, aes(x = ActualAge, y = PredictedAge)) +
  geom_point(color = "steelblue", size = 3, alpha = 0.7) +
  geom_abline(intercept = 0, slope = 1, color = "coral1", linetype = "dashed", size = 1) +
  labs(title = "Elastic Net: Predicted vs Actual Age (Subset)",
       x = "Actual Age",
       y = "Predicted Age") +
  theme_minimal()+
  annotate("text", x = min(pred_df$ActualAge), y = max(pred_df$PredictedAge), 
           label = paste0("R² = ", round(R2, 2), 
                          "\nMAE = ", round(MAE, 2), 
                          "\nRMSE = ", round(RMSE, 2)), 
           hjust = 0, vjust = 1, size = 4, color = "black")
```



The R² of 0.672 indicates that about 67% of the variance in chronological age is explained by the model.
The MAE of 5.73 years shows that, on average, the predicted age deviates from the actual age by approximately 5 to 6 years. 
The RMSE of 6.62 years reflects the overall magnitude of prediction errors, giving slightly more weight to larger deviations.
