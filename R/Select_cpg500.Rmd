---
title: 'Select 500 CpG sites most correlated with chronological age '
author: "Magalí Eisik"
output:
  html_document:
    df_print: paged
---


In this document, the 500 CpG sites most correlated with chronological age are selected. Missing data are imputed to ensure completeness, and beta values are converted to M values to improve statistical properties for future analyses that assume normality and homoscedasticity.


```{r warning=FALSE,message=FALSE}
#Load require packages
library(dplyr)    
library(readr)    
library(knitr)    
library(kableExtra)
library(knitr)

```



```{r echo=FALSE}
#Load data set
#Load data set
merged_500 <- read_csv(
  "C:/Users/Owner/Desktop/BINF7770/GSE55763_merged_500.csv",
  show_col_types = FALSE
)

```


Select top 500 more correlated


```{r}
# Metadata columns
meta_cols <- c("X", "gender", "age")

# Extract CpG columns only
cpg_matrix <- merged_500 %>% select(-all_of(meta_cols))

# Ensure numeric
cpg_matrix <- cpg_matrix %>% mutate(across(everything(), as.numeric))

# Correlation with age
cors <- sapply(cpg_matrix, function(x) cor(x, merged_500$age, use = "pairwise.complete.obs"))

# Top 500 CpGs by absolute correlation
top500 <- names(sort(abs(cors), decreasing = TRUE))[1:500]

# Subset dataset: metadata + top 500 CpGs
subset_500 <- merged_500 %>% select(all_of(meta_cols), all_of(top500))

# Save to CSV
write.csv(merged_500, "GSE55763_merged_500.csv", 
          row.names = FALSE)
```



```{r}
#Table with correlation coeficientes
# Convert to data frame
cors_df <- data.frame(
  CpG_ID = names(cors),
  Correlation = as.numeric(cors),
  stringsAsFactors = FALSE
)

rownames(cors_df) <- NULL

# Sort by absolute correlation (order desc)
cors_df <- cors_df %>% arrange(desc(abs(Correlation)))

# Display table
kable(cors_df[1:20, ],
      caption = "Top 20 CpGs most correlated with Age",
      digits = 3)
```



```{r}
# Metadata columns
meta_cols <- c("X", "gender", "age")


# Extract only metadata + top 500 CpGs
subset_500 <- merged_500 %>% select(all_of(meta_cols), all_of(top500))


# See first 3 rows and dimensions
head(subset_500,3)
dim(subset_500)
```


`
```{r}

# Save to CSV
write.csv(subset_500, "GSE55763_merged_500.csv", row.names = FALSE)
```


Missing value analysis

```{r}
# Missing values
na_total <- sum(is.na(subset_500))

# Total entries
entries_na<- nrow(subset_500) * ncol(subset_500)

# Percentage
percent_missing <- na_total / entries_na * 100

```

The dataset has `r na_total` missing values , which is `r sprintf("%.2f", percent_missing)`% missing.

In this case, missing values are assumed to be Missing Completely at Random (MCAR) and will be imputed using the median of each CpG.

```{r}
# Select CpG columns
X_cpg <- subset_500[, 4:ncol(subset_500)]

# Impute missing values using the median
X_cpg_imputed <- as.data.frame(lapply(X_cpg, function(x) {
  x[is.na(x)] <- median(x, na.rm = TRUE)
  x
}))

# Combine metadata with imputed CpGs
subset_500_imputed <- cbind(subset_500[, 1:3], X_cpg_imputed)

# Verify no NAs remain
sum(is.na(subset_500_imputed))
```

```{r}
#Save Beta values as a CSV file
write.csv(subset_500_imputed, "subset_500_Beta.csv", row.names = FALSE)
```




Beta-values need to be converted to M-values (log2 ratio of methylated/unmethylated) to improve normality and homoscedasticity for linear modeling with Elastic Net.”




```{r}
# Define metadata columns
meta_cols <- c("X", "gender", "age")  

# Extract CpG columns
cpg_matrix <- subset_500_imputed %>% select(-all_of(meta_cols))

cpg_matrix <- cpg_matrix %>%
  mutate(across(everything(), ~pmin(pmax(., 1e-6), 1 - 1e-6)))

# Convert to M values
m_matrix <- log2(cpg_matrix / (1 - cpg_matrix))

# Combine with metadata
subset_500_mvalues <- bind_cols(subset_500_imputed %>% select(all_of(meta_cols)), m_matrix)
```


```{r}
#Save M values as a CSV file
write.csv(subset_500_mvalues, "GSE55763_top500_Mvalues.csv", row.names = FALSE)
```

